# Prisma + NestJS + DDDè®¾è®¡ Example

## ğŸ“ é¡¹ç›®ç»“æ„

```
â¯ tree -I "node_modules|.git|dist"
prisma_nestjs_example/
â”œâ”€â”€ prisma
â”‚   â”œâ”€â”€ migrations
â”‚   â”‚   â””â”€â”€ migration_lock.toml
â”‚   â””â”€â”€ schema.prisma
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ app.module.ts
â”‚   â”œâ”€â”€ main.ts
â”‚   â”œâ”€â”€ modules
â”‚   â”‚   â””â”€â”€ product
â”‚   â”‚       â”œâ”€â”€ application
â”‚   â”‚       â”‚   â”œâ”€â”€ dtos
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ create-product.dto.ts
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ vo
â”‚   â”‚       â”‚   â”‚       â””â”€â”€ product.vo.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ mappers
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ product.mapper.ts
â”‚   â”‚       â”‚   â””â”€â”€ services
â”‚   â”‚       â”‚       â””â”€â”€ product.service.ts
â”‚   â”‚       â”œâ”€â”€ controller
â”‚   â”‚       â”‚   â””â”€â”€ product.controller.ts
â”‚   â”‚       â”œâ”€â”€ domain
â”‚   â”‚       â”‚   â”œâ”€â”€ aggregates
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ product.aggregate-root.ts
â”‚   â”‚       â”‚   â””â”€â”€ repositories
â”‚   â”‚       â”‚       â””â”€â”€ product.repository.ts
â”‚   â”‚       â”œâ”€â”€ infrastructure
â”‚   â”‚       â”‚   â”œâ”€â”€ mappers
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ product.prisma-mapper.ts
â”‚   â”‚       â”‚   â””â”€â”€ repositories
â”‚   â”‚       â”‚       â””â”€â”€ prisma-product.repository.ts
â”‚   â”‚       â””â”€â”€ product.module.ts
â”‚   â””â”€â”€ shared
â”‚       â”œâ”€â”€ domain
â”‚       â”‚   â”œâ”€â”€ aggregate-root.base.ts
â”‚       â”‚   â”œâ”€â”€ entity.base.ts
â”‚       â”‚   â””â”€â”€ value-object.entity.ts
â”‚       â””â”€â”€ infrastructure
â”‚           â””â”€â”€ prisma
â”‚               â”œâ”€â”€ prisma.module.ts
â”‚               â””â”€â”€ prisma.service.ts
â”œâ”€â”€ nest-cli.json
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ README.md
â””â”€â”€ tsconfig.json
```

---

## ğŸ›ï¸ åœºæ™¯ä¸€ï¼šå•†å“ç®¡ç† (Product)

å•†å“ç®¡ç†ï¼Œä»è¡¨é¢çœ‹ï¼Œä¼¼ä¹åªæ˜¯ç®€å•çš„å¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰ã€‚åœ¨ä¼ ç»Ÿæ¶æ„ä¸­ï¼Œè¿™å¯èƒ½å°±æ˜¯ä¸€ä¸ªControllerç›´æ¥è°ƒç”¨ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰æ•°æ®åº“æ“ä½œçš„Serviceã€‚ä½†å³ä½¿æ˜¯è¿™æ ·ç®€å•çš„åœºæ™¯ï¼ŒDDDä¹Ÿä¸ºæˆ‘ä»¬æ³¨å…¥äº†çºªå¾‹æ€§å’Œé•¿è¿œçš„å¥å£®æ€§ã€‚

### ğŸ“‹ ä¸šåŠ¡æµç¨‹

- **åˆ›å»ºå•†å“**ï¼šç®¡ç†å‘˜å½•å…¥ä¸€ä¸ªæ–°å•†å“ï¼ŒåŒ…å«åç§°ã€ä»·æ ¼ã€SKUã€åˆå§‹åº“å­˜ç­‰ä¿¡æ¯ã€‚
- **æŸ¥è¯¢å•†å“**ï¼šç”¨æˆ·æˆ–ç³»ç»Ÿå¯ä»¥æ ¹æ®IDæˆ–SKUæŸ¥è¯¢å•†å“è¯¦æƒ…ã€‚
- **æ›´æ–°åº“å­˜**ï¼šåœ¨å”®å‡ºåï¼Œå•†å“çš„åº“å­˜éœ€è¦è¢«æ‰£å‡ã€‚

### ğŸ§  DDDæ€æƒ³è§£è¯»

#### 1. ProductAggregateï¼šä¸ä»…ä»…æ˜¯æ•°æ®ï¼Œæ›´æ˜¯ä¸šåŠ¡è§„åˆ™çš„å®ˆæŠ¤è€…

ä¼ ç»ŸMVCä¸­çš„Productå®ä½“é€šå¸¸æ˜¯ä¸€ä¸ª"è´«è¡€"æ¨¡å‹ï¼Œåªæœ‰ä¸€å †getter/setterã€‚è€Œæˆ‘ä»¬çš„ProductAggregateåˆ™æ˜¯ä¸€ä¸ª"å……è¡€"æ¨¡å‹ï¼Œå®ƒæ˜¯æœ‰ç”Ÿå‘½å’Œæ™ºæ…§çš„ã€‚

**ä¸å˜é‡ä¿æŠ¤ (Invariant Protection)ï¼š** èšåˆæ ¹çš„é¦–è¦èŒè´£æ˜¯ä¿æŠ¤å…¶å†…éƒ¨æ•°æ®çš„ä¸€è‡´æ€§å’Œä¸šåŠ¡è§„åˆ™çš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º"ä¸å˜é‡"ã€‚åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼ŒProductAggregate.create()å·¥å‚æ–¹æ³•å°±æ˜¯è¿™ä¸ªä¸å˜é‡çš„"å®ˆé—¨äºº"ã€‚

```typescript
// src/modules/product/domain/aggregates/product.aggregate-root.ts
public static create(props: Omit<ProductProps, ...>): ProductAggregate {
  // è§„åˆ™1ï¼šä»·æ ¼ä¸èƒ½ä¸ºè´Ÿ
  if (props.price < 0) {
    throw new Error('Product price cannot be negative.');
  }
  // è§„åˆ™2ï¼šåº“å­˜ä¸èƒ½ä¸ºè´Ÿ
  if (props.stock < 0) {
    throw new Error('Product stock cannot be negative.');
  }
  return new ProductAggregate(props);
}
```

ä»»ä½•è¯•å›¾åˆ›å»ºä¸åˆæ³•äº§å“çš„å°è¯•éƒ½ä¼šåœ¨é¢†åŸŸå±‚è¢«ç«‹åˆ»æ‹’ç»ï¼Œè€Œä¸æ˜¯ç­‰åˆ°æ•°æ®å­˜å…¥æ•°æ®åº“æ—¶æ‰æŠ¥é”™ã€‚

**å°è£…ä¸šåŠ¡è¡Œä¸ºï¼š** å½“éœ€è¦ä¿®æ”¹åº“å­˜æ—¶ï¼Œæˆ‘ä»¬ä¸æ˜¯æä¾›ä¸€ä¸ªsetStock(number)æ–¹æ³•ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªæ„å›¾æ˜ç¡®çš„decreaseStock(quantity: number)æ–¹æ³•ã€‚

```typescript
public decreaseStock(quantity: number): void {
  // å°è£…äº†"åº“å­˜ä¸èƒ½è¢«å‡æˆè´Ÿæ•°"çš„ä¸šåŠ¡è§„åˆ™
  if (this.props.stock < quantity) {
    throw new Error('Insufficient stock.');
  }
  this.props.stock -= quantity;
  this.props.updatedAt = new Date();
}
```

è¿™ç¡®ä¿äº†å¯¹èšåˆæ ¹çŠ¶æ€çš„æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ã€ç¬¦åˆä¸šåŠ¡è§„åˆ™çš„"åŠ¨è¯"æ¥å®Œæˆçš„ã€‚

#### 2. ProductRepositoryï¼šéš”ç¦»æŠ€æœ¯å¤æ‚æ€§

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡çš„ProductRepositoryæ¥å£åœ¨é¢†åŸŸå±‚ï¼Œè€Œå°†åŸºäºPrismaçš„å…·ä½“å®ç°æ”¾åœ¨äº†åŸºç¡€è®¾æ–½å±‚ã€‚è¿™å¸¦æ¥äº†å·¨å¤§çš„å¥½å¤„ï¼š

- **æ ¸å¿ƒä¸šåŠ¡çº¯ç²¹æ€§**ï¼šæˆ‘ä»¬çš„ProductAggregateå’Œåº”ç”¨å±‚çš„ProductServiceå®Œå…¨ä¸çŸ¥é“Prismaçš„å­˜åœ¨ã€‚å®ƒä»¬åªä¾èµ–äºé‚£ä¸ªæŠ½è±¡çš„ã€ç¨³å®šçš„æ¥å£ã€‚
- **å¯æµ‹è¯•æ€§**ï¼šåœ¨ä¸ºProductServiceç¼–å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿æ¥ä¸€ä¸ªçœŸå®çš„æ•°æ®åº“ã€‚æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åˆ›å»ºä¸€ä¸ªå†…å­˜ç‰ˆçš„MockProductRepositoryæ¥æ¨¡æ‹Ÿæ•°æ®å­˜å–ï¼Œè®©æµ‹è¯•å˜å¾—é£å¿«ä¸”æ— å‰¯ä½œç”¨ã€‚

> ğŸ’¡ **å…³é”®æ´å¯Ÿ**  
> è¿™ä¸ªç®€å•çš„å•†å“ç®¡ç†åœºæ™¯ï¼Œå‘Šè¯‰æˆ‘ä»¬ï¼šDDDçš„ä»·å€¼åœ¨äºä»é¡¹ç›®ç¬¬ä¸€å¤©èµ·å°±å»ºç«‹èµ·è‰¯å¥½çš„çºªå¾‹ã€‚å®ƒé€šè¿‡èšåˆæ ¹å°è£…ä¸šåŠ¡ã€é€šè¿‡ä»“å‚¨éš”ç¦»æŠ€æœ¯ï¼Œä¸ºç³»ç»Ÿæœªæ¥çš„æ¼”è¿›é“ºè®¾äº†ä¸€æ¡æ¸…æ™°ã€å¯æ§çš„é“è·¯ã€‚

---

## ğŸ“¦ åœºæ™¯äºŒï¼šè®¢å•ç”Ÿå‘½å‘¨æœŸ (Order)

è®¢å•æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå…¶ä¸šåŠ¡é€»è¾‘é”™ç»¼å¤æ‚ã€‚è¿™æ­£æ˜¯ä¼ ç»Ÿæ¶æ„çš„"æ»‘é“å¢"ï¼Œä¹Ÿæ°æ°æ˜¯DDDå¤§æ”¾å¼‚å½©çš„èˆå°ã€‚

### ğŸ“‹ ä¸šåŠ¡æµç¨‹

- **æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦**ï¼šç”¨æˆ·é€‰æ‹©å•†å“å’Œæ•°é‡ï¼Œå°†å…¶åŠ å…¥è´­ç‰©è½¦ï¼ˆä¸€ä¸ªDRAFTçŠ¶æ€çš„è®¢å•ï¼‰ã€‚
- **ç¡®è®¤è®¢å•å¹¶ç»“ç®—**ï¼šç”¨æˆ·ç¡®è®¤è´­ç‰©è½¦å†…å®¹ï¼Œç³»ç»Ÿåº”ç”¨å¯èƒ½çš„æŠ˜æ‰£ï¼Œå¹¶ç”Ÿæˆæœ€ç»ˆå¾…æ”¯ä»˜é‡‘é¢ã€‚
- **æ”¯ä»˜æˆåŠŸ**ï¼šç”¨æˆ·å®Œæˆæ”¯ä»˜ï¼Œç³»ç»Ÿéœ€è¦è§¦å‘ä¸€ç³»åˆ—åç»­æ“ä½œï¼ˆæ‰£åº“å­˜ã€åŠ ç§¯åˆ†ã€å‘é€šçŸ¥ç­‰ï¼‰ã€‚

### ğŸ§  DDDæ€æƒ³è§£è¯»

#### 1. OrderAggregateï¼šå¤æ‚ä¸šåŠ¡å…³ç³»çš„ä¸€è‡´æ€§ä¿è¯

OrderAggregateæ˜¯è¿™ä¸ªæµç¨‹ä¸­çš„ç»å¯¹ä¸»è§’ã€‚å®ƒç®¡ç†ç€Orderè‡ªèº«çš„çŠ¶æ€ï¼Œä»¥åŠå…¶å†…éƒ¨OrderItemå®ä½“çš„é›†åˆã€‚

**ç»´æŠ¤å†…éƒ¨ä¸€è‡´æ€§ï¼š** å½“ä¸€ä¸ªå•†å“è¢«æ·»åŠ æ—¶ï¼ŒaddItemæ–¹æ³•ä¸ä»…è¦å¤„ç†OrderItemçš„å¢åŠ æˆ–æ•°é‡æ›´æ–°ï¼Œè¿˜å¿…é¡»ç«‹å³ã€åŸå­åœ°è°ƒç”¨ç§æœ‰çš„recalculateTotal()æ–¹æ³•æ¥æ›´æ–°è®¢å•æ€»ä»·ã€‚

```typescript
// src/modules/order/domain/aggregates/order.aggregate-root.ts
public addItem(product: ProductSnapshot, quantity: number): void {
  // ... æ£€æŸ¥åº“å­˜ã€çŠ¶æ€ç­‰è§„åˆ™ ...
  // â˜… å…³é”®ï¼šèšåˆæ ¹è‡ªå·±è´Ÿè´£ç»´æŠ¤å†…éƒ¨çŠ¶æ€çš„ä¸€è‡´æ€§ï¼
  this.recalculateTotal();
}
```

åœ¨ä¼ ç»ŸMVCä¸­ï¼Œè¿™ä¸ª"æ›´æ–°æ€»ä»·"çš„é€»è¾‘ææœ‰å¯èƒ½è¢«é—å¿˜åœ¨OrderServiceçš„æŸä¸ªè§’è½ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚è€Œåœ¨DDDä¸­ï¼Œèšåˆæ ¹è‡ªèº«çš„è®¾è®¡å°±æœç»äº†è¿™ç§å¯èƒ½ã€‚

**ä½œä¸ºçŠ¶æ€æœºï¼š** OrderAggregateé€šè¿‡statuså­—æ®µå’Œä¸€ç³»åˆ—ä¸šåŠ¡æ–¹æ³•ï¼ˆconfirmForPayment, markAsPaidï¼‰ï¼Œæ„æˆäº†ä¸€ä¸ªä¸¥è°¨çš„ä¸šåŠ¡æµç¨‹çŠ¶æ€æœºã€‚ä½ ä¸èƒ½å¯¹ä¸€ä¸ªå·²ç»æ”¯ä»˜çš„è®¢å•å†æ·»åŠ å•†å“ï¼Œè¿™äº›è§„åˆ™éƒ½è¢«å°è£…åœ¨èšåˆæ ¹çš„æ–¹æ³•ä¸­ï¼Œä¿è¯äº†ä¸šåŠ¡æµç¨‹çš„æ­£ç¡®æµè½¬ã€‚

#### 2. åŒæ­¥è®¡ç®— vs. å¼‚æ­¥åæœï¼šé¢†åŸŸäº‹ä»¶

è¿™æ˜¯è®¢å•æµç¨‹ä¸­æœ€èƒ½ä½“ç°DDDå¼ºå¤§è¡¨è¾¾åŠ›çš„éƒ¨åˆ†ã€‚

**åŒæ­¥è®¡ç®—ï¼šDiscountServiceï¼ˆé¢†åŸŸæœåŠ¡ï¼‰çš„ç™»åœº**  
åœ¨"ç¡®è®¤è®¢å•å¹¶ç»“ç®—"è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å¿…é¡»åŒæ­¥åœ°è®¡ç®—å‡ºæœ€ç»ˆä»·æ ¼ã€‚è¿™ä¸ªè®¡ç®—é€»è¾‘å¤æ‚ï¼ˆéœ€è¦è®¢å•ã€ç”¨æˆ·ã€ä¿ƒé”€ç­‰å¤šä¸ªèšåˆçš„ä¿¡æ¯ï¼‰ï¼Œä¸”ä¸»æµç¨‹å¿…é¡»ç­‰å¾…å…¶ç»“æœã€‚æ­¤æ—¶ï¼Œé¢†åŸŸæœåŠ¡åº”è¿è€Œç”Ÿã€‚å®ƒè´Ÿè´£æ‰§è¡Œè¿™ä¸ªè·¨èšåˆçš„è®¡ç®—ï¼Œå¹¶ç«‹å³è¿”å›ç»“æœï¼Œä¾›ä¸»æµç¨‹ä½¿ç”¨ã€‚

**å¼‚æ­¥åæœï¼šOrderPaidEventï¼ˆé¢†åŸŸäº‹ä»¶ï¼‰çš„è§£è€¦é­”æ³•**  
åœ¨"æ”¯ä»˜æˆåŠŸ"è¿™ä¸€æ­¥ï¼Œè®¢å•çš„æ ¸å¿ƒèŒè´£å·²ç»å®Œæˆã€‚åç»­çš„"æ‰£åº“å­˜"ã€"åŠ ç§¯åˆ†"éƒ½æ˜¯è¿™ä¸ªæ ¸å¿ƒäº‹å®å¼•å‘çš„åæœï¼ˆConsequencesï¼‰ã€‚æ­¤æ—¶ï¼ŒOrderAggregateçš„markAsPaid()æ–¹æ³•ä¸å†å»ç›´æ¥è°ƒç”¨ProductRepositoryï¼Œè€Œæ˜¯å‘å¸ƒä¸€ä¸ªOrderPaidEventé¢†åŸŸäº‹ä»¶ã€‚

```typescript
// src/modules/order/domain/aggregates/order.aggregate-root.ts
public markAsPaid(): void {
  // ... çŠ¶æ€æ£€æŸ¥ ...
  this.props.status = OrderStatus.PAID;
  // â˜… å®£å¸ƒï¼ˆPublishï¼‰ä¸€ä¸ªäº‹å®ï¼Œè€Œä¸æ˜¯æ‰§è¡Œï¼ˆCommandï¼‰ä¸€ä¸ªåŠ¨ä½œ
  this.addDomainEvent(new OrderPaidEvent(/* ... */));
}
```

è¿™å¸¦æ¥äº†é©å‘½æ€§çš„æ”¹å˜ï¼šé«˜åº¦è§£è€¦ã€æå¼ºçš„å¯æ‰©å±•æ€§ï¼ˆç¬¦åˆå¼€é—­åŸåˆ™ï¼‰ã€æå‡ç³»ç»Ÿå¼¹æ€§å’Œæ€§èƒ½ï¼ˆé€šè¿‡æœ€ç»ˆä¸€è‡´æ€§é¿å…å¤§äº‹åŠ¡ï¼‰ã€‚

---

## ğŸ” åœºæ™¯ä¸‰ï¼šå¤æ‚éªŒè¯è§„åˆ™çš„å¤„ç†

### ğŸ“‹ ä¸šåŠ¡æµç¨‹

åœ¨è®¢å•ä» DRAFT çŠ¶æ€è½¬ä¸º PENDING_PAYMENT ä¹‹å‰ï¼Œç³»ç»Ÿå¿…é¡»æ‰§è¡Œä¸€é¡¹ç‰¹æ®Šçš„éªŒè¯è§„åˆ™ï¼š

> "å¯¹äºéVIPå®¢æˆ·ï¼Œå¦‚æœè®¢å•æ€»ä»·è¶…è¿‡5000å…ƒï¼Œæˆ–è€…è®¢å•ä¸­åŒ…å«ä»»ä½•'å¥¢ä¾ˆå“'åˆ†ç±»çš„å•†å“ï¼Œé‚£ä¹ˆè¯¥è®¢å•éœ€è¦ä¸€ä¸ª'é«˜ä»·å€¼è®¢å•'çš„æ ‡è®°ï¼Œå¹¶å¯èƒ½éœ€è¦äººå·¥å®¡æ ¸ã€‚"

### ğŸ”¬ åˆ†æï¼š

- è¿™ä¸ªéªŒè¯é€»è¾‘æ˜¾ç„¶å¾ˆå¤æ‚ï¼Œä¸é€‚åˆæ”¾åœ¨OrderAggregateå†…éƒ¨ï¼Œå› ä¸ºå®ƒéœ€è¦çŸ¥é“Userçš„ä¿¡æ¯ï¼ˆæ˜¯å¦VIPï¼‰å’ŒProductçš„ä¿¡æ¯ï¼ˆæ˜¯å¦å¥¢ä¾ˆå“ï¼‰ã€‚
- å®ƒå¿…é¡»åœ¨è®¢å•ç¡®è®¤çš„åŒä¸€ä¸ªäº‹åŠ¡ä¸­åŒæ­¥å®Œæˆã€‚
- æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæœåŠ¡çš„æ ¸å¿ƒä¸šåŠ¡æ¦‚å¿µæ˜¯"éªŒè¯ä¸€ä¸ªè®¢å•"ã€‚å®ƒçš„ä¸Šä¸‹æ–‡å®Œå…¨æ˜¯å›´ç»•"è®¢å•"è¿™ä¸ªæ¨¡å—çš„ã€‚
